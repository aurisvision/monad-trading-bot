version: '3.8'

services:
  area51-bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: area51-bot-production
    restart: unless-stopped
    
    environment:
      # Application Configuration
      NODE_ENV: production
      TZ: UTC
      
      # Database Configuration - PostgreSQL 17
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_SSL_MODE: ${POSTGRES_SSL_MODE:-disable}
      POSTGRES_APPLICATION_NAME: ${POSTGRES_APPLICATION_NAME:-area51_bot}
      POSTGRES_CLIENT_ENCODING: ${POSTGRES_CLIENT_ENCODING:-utf8}
      POSTGRES_CONNECT_TIMEOUT: ${POSTGRES_CONNECT_TIMEOUT:-60000}
      POSTGRES_COMMAND_TIMEOUT: ${POSTGRES_COMMAND_TIMEOUT:-30000}
      
      # Redis Configuration
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_USERNAME: ${REDIS_USERNAME:-redis}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_KEY_PREFIX: ${REDIS_KEY_PREFIX:-area51:}
      REDIS_CONNECTION_TIMEOUT: ${REDIS_CONNECTION_TIMEOUT:-5000}
      REDIS_COMMAND_TIMEOUT: ${REDIS_COMMAND_TIMEOUT:-5000}
      REDIS_MAX_RETRIES: ${REDIS_MAX_RETRIES:-3}
      REDIS_RETRY_DELAY: ${REDIS_RETRY_DELAY:-100}
      REDIS_POOL_SIZE: ${REDIS_POOL_SIZE:-10}
      
      # Bot Configuration
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      ADMIN_USER_ID: ${ADMIN_USER_ID}
      ACCESS_CONTROL_ENABLED: ${ACCESS_CONTROL_ENABLED:-true}
      
      # Performance Configuration
      DATABASE_POOL_SIZE: ${DATABASE_POOL_SIZE:-25}
      DATABASE_TIMEOUT: ${DATABASE_TIMEOUT:-30000}
      CLUSTER_WORKERS: ${CLUSTER_WORKERS:-4}
      MAX_WORKERS: ${MAX_WORKERS:-8}
      MAX_CONNECTIONS_PER_WORKER: ${MAX_CONNECTIONS_PER_WORKER:-2500}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_REQUESTS_PER_MINUTE: ${RATE_LIMIT_REQUESTS_PER_MINUTE:-30}
      RATE_LIMIT_TRANSACTIONS_PER_HOUR: ${RATE_LIMIT_TRANSACTIONS_PER_HOUR:-100}
      MAX_REQUESTS_PER_MINUTE: ${MAX_REQUESTS_PER_MINUTE:-60}
      MAX_TRANSACTIONS_PER_HOUR: ${MAX_TRANSACTIONS_PER_HOUR:-100}
      
      # Caching Configuration
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      BACKGROUND_REFRESH_ENABLED: ${BACKGROUND_REFRESH_ENABLED:-true}
      PORTFOLIO_REFRESH_INTERVAL: ${PORTFOLIO_REFRESH_INTERVAL:-600000}
      GLOBAL_PRICE_REFRESH_INTERVAL: ${GLOBAL_PRICE_REFRESH_INTERVAL:-120000}
      ACTIVE_USER_THRESHOLD_MINUTES: ${ACTIVE_USER_THRESHOLD_MINUTES:-30}
      
      # Monad Network Configuration
      CHAIN_ID: ${CHAIN_ID:-10143}
      MONAD_RPC_URL: ${MONAD_RPC_URL:-https://testnet-rpc.monad.xyz}
      
      # Monorail Configuration
      MONORAIL_APP_ID: ${MONORAIL_APP_ID}
      MONORAIL_DATA_URL: ${MONORAIL_DATA_URL:-https://testnet-api.monorail.xyz/v1}
      MONORAIL_QUOTE_URL: ${MONORAIL_QUOTE_URL:-https://testnet-pathfinder.monorail.xyz/v4}
      
      # Trading Configuration
      DEFAULT_GAS_LIMIT: ${DEFAULT_GAS_LIMIT:-250000}
      DEFAULT_GAS_PRICE_GWEI: ${DEFAULT_GAS_PRICE_GWEI:-20}
      DEFAULT_SLIPPAGE_BPS: ${DEFAULT_SLIPPAGE_BPS:-10}
      MAX_SLIPPAGE: ${MAX_SLIPPAGE:-5}
      
      # Security Configuration
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      
      # Monitoring Configuration
      HEALTH_CHECK_PORT: ${HEALTH_CHECK_PORT:-3001}
      METRICS_ENABLED: ${METRICS_ENABLED:-true}
      METRICS_PORT: ${METRICS_PORT:-3002}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Backup Configuration
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      
      # UI Configuration
      AUTO_DELETE_TIMEOUT: ${AUTO_DELETE_TIMEOUT:-15000}
      
      # Redis Monitoring
      REDIS_METRICS_ENABLED: ${REDIS_METRICS_ENABLED:-true}
      REDIS_ALERT_THRESHOLDS_HIT_RATE_MIN: ${REDIS_ALERT_THRESHOLDS_HIT_RATE_MIN:-70}
      REDIS_ALERT_THRESHOLDS_RESPONSE_TIME_MAX: ${REDIS_ALERT_THRESHOLDS_RESPONSE_TIME_MAX:-100}
      REDIS_ALERT_THRESHOLDS_MEMORY_USAGE_MAX: ${REDIS_ALERT_THRESHOLDS_MEMORY_USAGE_MAX:-100}
      REDIS_ALERT_THRESHOLDS_ERROR_RATE_MAX: ${REDIS_ALERT_THRESHOLDS_ERROR_RATE_MAX:-5}
    
    ports:
      - "3000:3000"   # Main application port
      - "3001:3001"   # Health check port
      - "3002:3002"   # Metrics port
    
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
      - ./temp:/app/temp
    
    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Network mode for Coolify
    network_mode: bridge

# Networks (optional, for custom networking)
networks:
  default:
    driver: bridge
